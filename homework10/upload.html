<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
</head>
<body>
    <input type="file" value="" name="excel" id="file" />
    <button id="upload" title="开始上传">开始上传</button>
    <button id="pause" >暂停</button>
    <button id="continues" >继续</button>
    <div id="file-name"></div>
    <progress id="uploadprogress" min="0" max="100" value="0">0</progress>
    <div class="image"></div>
    <script>
    (function(){    
        var file = document.querySelector('#file');
        var upload = document.querySelector('#upload');
        var pause = document.querySelector('#pause');
        var continues = document.querySelector('#continues');
        var uploadprogress = document.querySelector('#uploadprogress');
        var image = document.querySelector('.image');
        
        upload.addEventListener('click', function(){
            var type = /^image\//;
            type.test(file.files[0].type) 
            var reader = new FileReader();
            reader.readAsDataURL(file.files[0]);
           
            $('#pause, progress').removeClass('hide');
            $.get('countsize.php?filename=' + encodeURIComponent(file.name), function (response) {
                currentPosition = response[file.name.replace(/\.\w+$/, '')];
                if (currentPosition == 0) {
                showProgress(currentPosition, file.size);
                upload(file);
            } 
            else if (currentPosition == file.size) {
                $('#pause, .progress').addClass('hide');
                alert('此文件已经上传完成!');
            }
            else if (currentPosition < file.size) {
                alert('此文件已经上传了' + Math.floor((currentPosition / file.size) * 100) + '%, 现在将继续上传!');
                $('#uploadprogress').width(currentPosition / file.size * 100 + '%');
                showProgress(currentPosition, file.size);
                upload(file);
                        }
            }, 'json');
        });

    pause.addEventListener('click', function () {
        pause = !pause;
    })
    continues.addEventListener('click', function () {
        pause = !pause;
        upLoad(inputFile.files[0]);
    });
    function upload(file) {
                var formData = new FormData();
                    formData.append("fileName", encodeURIComponent(file.name));
                    formData.append("filePart", file.slice(currentPosition, currentPosition + partSize));
                $.ajax({
                    type: 'POST',
                    url: 'upload.php',
                    data: formData,
                    contentType: false, // 
                    processData: false, // 
                    // 设置 xhr 对象，增加 onprogress 事件
                    xhr: function() {
                        var xhr = $.ajaxSettings.xhr();
                        xhr.upload.onprogress = function (event) {
                            showProgress(currentPosition + event.loaded, file.size);
                        }
                        return xhr
                    },
                    success: function () {
                        // 每上传完一部分就改变当前位置
                        currentPosition += partSize;
                        if (currentPosition < file.size) {
                            if (!pause) {
                                setTimeout(function () {
                                    upload(file);
                                }, 300);
                            }
                        } else {
                            $('#pause, #uploadprogress').addClass('hide')
                            alert('上传结束');
                        }
                    },
                    error: function () {
                        alert('上传错误');
                    }
                });
            }})

    </script>


</body>
</html>



